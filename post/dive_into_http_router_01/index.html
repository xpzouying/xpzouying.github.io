<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>zouying.is</title>

  
  
  <meta name="author" content="zouying" />
  <meta name="description" content="golang默认的http router 我们从Golang的http router开始学习，学习下面几点：
 分析什么是router
 解析Go内部是如何实现router
 分析为什么Go内部已经有了router后还会出现各种个样的router，他们提供了哪些Go内部router不能完成的功能
 我们如何实现一个自定义的router
 我们如何在自定义的router上面完成我们想要的各种功能：高效率、Middleware、异常捕获及处理、如何简单的完成JSON类型的返回等等
  
" />





<meta name="generator" content="Hugo 0.50" />


<link rel="canonical" href="https://xpzouying.github.io/post/dive_into_http_router_01/" />
<link rel="alternative" href="https://xpzouying.github.io/index.xml" title="zouying.is" type="application/atom+xml" />

<link href="https://cdn.bootcss.com/semantic-ui/2.2.14/semantic.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://xpzouying.github.io/css/site.css" />


</head>

<body>
  <div class="flip-container">
    <div class="flipper">
      <section class="front">
        
<nav class="ui top secondary menu">
  <div class="item">
    <i class="inverted big link bullseye icon dream-flip-toggle" title="翻转！"></i>
  </div>
  <div class="item">
    <a href="https://xpzouying.github.io/">
      <i class="inverted big link home icon" title="首页"></i>
    </a>
  </div>
</nav>
 
<div class="ui centered grid">
  <div class="fifteen wide mobile fifteen wide tablet eleven wide computer column post-list post-single-main">

    <section class="ui secondary top attached black segment">
      <a class="ui black right corner label" href="javascript:void(0)" onclick="savePostAsImg()">
        <i class="save icon"></i>
      </a>
      <header>
        <h1 class="ui header">
          Dive Into HTTP Router in Golang
          <div class="sub header">@ zouying · Nov 19, 2018 · 3 min read · 更新于 Nov 19, 2018</div>
        </h1>
      </header>
      <article class="post-content" style="margin-top: 2rem; font-size: 1.4rem;"><h1 id="golang默认的http-router">golang默认的http router</h1>

<p>我们从Golang的http router开始学习，学习下面几点：</p>

<ol>
<li><p>分析什么是router</p></li>

<li><p>解析Go内部是如何实现router</p></li>

<li><p>分析为什么Go内部已经有了router后还会出现各种个样的router，他们提供了哪些Go内部router不能完成的功能</p></li>

<li><p>我们如何实现一个自定义的router</p></li>

<li><p>我们如何在自定义的router上面完成我们想要的各种功能：高效率、Middleware、异常捕获及处理、如何简单的完成JSON类型的返回等等</p></li>
</ol>

<p></p>

<h2 id="demo">DEMO</h2>

<p>首先看golang默认的http router是如何工作的。</p>

<p>看一个简单的例子，</p>
<div class="highlight"><pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;html&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">fooHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello, %q&#34;</span><span class="p">,</span> <span class="nx">html</span><span class="p">.</span><span class="nx">EscapeString</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&#34;/foo&#34;</span><span class="p">,</span> <span class="nx">fooHandler</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&#34;/bar&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello, %q&#34;</span><span class="p">,</span> <span class="nx">html</span><span class="p">.</span><span class="nx">EscapeString</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">))</span>
	<span class="p">})</span>

	<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
<span class="p">}</span></code></pre></div>
<p>运行：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go run main.go</code></pre></div>
<p>调用：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl http://localhost:8080/foo

<span class="c1"># Hello, &#34;/foo&#34;
</span><span class="c1"></span>
curl http://localhost:8080/bar

<span class="c1"># Hello, &#34;/bar&#34;
</span><span class="c1"></span>
curl http://localhost:8080/

# <span class="m">404</span> page not found</code></pre></div>
<h2 id="现象">现象</h2>

<ol>
<li><p>注册了两个函数用于处理请求</p>

<ul>
<li><p><code>/foo</code>：通过<code>fooHandler</code>进行处理</p></li>

<li><p><code>/bar</code>：通过<code>func(w http.ResponseWriter, r *http.Request)</code>进行处理</p></li>
</ul></li>

<li><p>HTTP service启动并监听<code>:8080</code>端口，等待客户端请求</p></li>

<li><p>客户端使用<code>curl</code>发起HTTP GET请求时，Golang根据调用的接口路径调用了不同的函数进行处理</p></li>
</ol>

<h2 id="原理">原理</h2>

<p>至关重要的是：如何把客户端的请求与服务器中HTTP处理函数关联起来，这也是路由器的工作。</p>

<h3 id="解析">解析</h3>

<p>查看<code>http.ListenAndServe(&quot;:8080&quot;, nil)</code>函数的内部，</p>

<p>方法<code>http.ListenAndServe</code>原型为：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ListenAndServe listens on the TCP network address addr and then calls
</span><span class="c1">// Serve with handler to handle requests on incoming connections.
</span><span class="c1">// Accepted connections are configured to enable TCP keep-alives.
</span><span class="c1">//
</span><span class="c1">// The handler is typically nil, in which case the DefaultServeMux is used.
</span><span class="c1">//
</span><span class="c1">// ListenAndServe always returns a non-nil error.
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">handler</span><span class="p">}</span>
	<span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">()</span>
<span class="p">}</span></code></pre></div>
<p><code>ListenAndServe</code>从注释上可以看到主要做了两个工作：</p>

<ol>
<li><p>监听(listen on)TCP的地址</p></li>

<li><p>调用<strong><code>handler</code></strong>的<code>Serve</code>来处理连接进来的请求</p></li>
</ol>

<p>如果<code>handler</code>，即第2个入参，为<code>nil</code>，则使用<code>DefaultServeMux</code>。</p>

<p>那么，DefaultServeMux又是什么呢？</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DefaultServeMux is the default ServeMux used by Serve.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">DefaultServeMux</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">defaultServeMux</span>

<span class="kd">var</span> <span class="nx">defaultServeMux</span> <span class="nx">ServeMux</span></code></pre></div>
<p>从代码上可以看到是<code>ServeMux</code>类型的对象，</p>

<p>这个类型的定义及重要解释为，</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ServeMux is an HTTP request multiplexer.
</span><span class="c1">// It matches the URL of each incoming request against a list of registered
</span><span class="c1">// patterns and calls the handler for the pattern that
</span><span class="c1">// most closely matches the URL.
</span><span class="c1">// ...
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ServeMux</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">mu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">m</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">muxEntry</span>
	<span class="nx">hosts</span> <span class="kt">bool</span> <span class="c1">// whether any patterns contain hostnames
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>ServeMux是一个HTTP的multiplexer，翻译过来就是：数据选择器或者叫多路复用器。</p>

<p>它的作用就是当来了一个HTTP请求后，根据请求的URL匹配服务器端已经注册好的各种处理函数，找到一个最合适的进行处理。</p>

<p>剩下的注释就是解释Golang自带的默认路由器是如何匹配各种情况的，暂时先跳过。</p></article>
    </section>

    <footer class="ui secondary attached segment dream-tags">
      
      
      <a class="ui label" href="https://xpzouying.github.io/tags/code" title="code">code</a>
      
      
    </footer>

    
    <footer class="ui secondary attached segment">
      © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you likes to quote or reproduce.
    </footer>
    

    

  </div>
  <div class="fifteen wide mobile fifteen wide tablet four wide computer column">

    <section class="ui top attached center aligned inverted segment">
  <div class="ui small circular image">
    
    <img src="https://xpzouying.github.io/img/avatar.jpg">
    
  </div>
  <h3 class="ui header">zouying的博客<div class="sub header" style="color: white;">我们都生活在阴沟里，但仍有人仰望星空</div>
  </h3>

  <div class="ui inverted horizontal list">
    
    <a class="item" href="https://xpzouying.github.io/post">
      <i class="archive icon" title="归档"></i>
    </a>
    
    <a class="item" href="https://xpzouying.github.io/tags">
      <i class="tags icon" title="所有标签"></i>
    </a>
    <a class="item" href="https://xpzouying.github.io/categories">
      <i class="inverted cubes icon" title="所有分类"></i>
    </a>
  </div>

  <a id="tag-category-pop" class="ui red right corner label">
    <i class="pointing down icon" title="点击弹出标签和分类"></i>
  </a>
</section>


<section class="ui attached center aligned inverted segment dream-header-tags dream-tags">
  
  <a class="ui label" href="https://xpzouying.github.io/tags/code" title="code">code</a>
  
  <a class="ui label" href="https://xpzouying.github.io/tags/life" title="life">life</a>
  
  <a class="ui label" href="https://xpzouying.github.io/tags/reading" title="reading">reading</a>
  
</section>



<section class="ui attached inverted segment dream-categories">
  <div class="ui inverted accordion">
    
    <div class="title">
      <i class="dropdown icon"></i>
      <a href="https://xpzouying.github.io/categories/code" class="item" style="color: white;">code</a>
    </div>
    <div class="content">
      <div class="ui link inverted list">
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/dive_into_beego_router/" class="item">Dive Into beego/router</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/dive_into_http_router_02/" class="item">Dive_into_http_router_02</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/dive_into_http_router_01/" class="item">Dive Into HTTP Router in Golang</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/dive_into_src_plan/" class="item">Dive Into Code</a>
        </div>
      </div>
      
      </div>
    </div>
    
    <div class="title">
      <i class="dropdown icon"></i>
      <a href="https://xpzouying.github.io/categories/life" class="item" style="color: white;">life</a>
    </div>
    <div class="content">
      <div class="ui link inverted list">
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/reading_notebook_201811/" class="item">2018年11月阅读记录</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/reading_notebook_201810/" class="item">2018年10月阅读记录</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/reading_notebook_201808/" class="item">2018年8月阅读记录</a>
        </div>
      </div>
      
      <div class="item" style="padding-left: 24px;">
        <i class="cocktail icon"></i>
        <div class="content">
          <a href="https://xpzouying.github.io/post/reading_notebook_201809/" class="item">2018年9月阅读记录</a>
        </div>
      </div>
      
      </div>
    </div>
    
  </div>
</section>


<section class="ui bottom attached center aligned inverted segment">
    
    <p>© 2018 zouying.is</p>
    
    <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</p>
</section>


  </div>
</div>

      </section>
      <section class="back">
        <nav class="ui top secondary menu" style="overflow-x: auto">
  <div class="item">
    <i class="inverted big link bullseye icon dream-flip-toggle" title="翻转！"></i>
  </div>
  
  <div class="item">
    <a href="mailto:xpzouying@gmail.com">
      <i class="inverted big mail icon" title="email"></i>
    </a>
  </div>
  
  
  <div class="item">
    <a href="https://github.com/xpzouying" target="_blank">
      <i class="inverted big github icon" title="github"></i>
    </a>
  </div>
  
  
  
  <div class="item">
    <a href="https://www.stackoverflow.com/users/701268/zouying" target="_blank">
      <i class="inverted big stack overflow icon" title="stackoverflow"></i>
    </a>
  </div>
  
  
</nav>

<div class="ui centered grid about">
  <div class="fifteen wide mobile fifteen wide tablet fifteen wide computer column">

    <section class="ui stacked segments">
      <header class="ui inverted segment">
        <h2 class="ui header">
          About
        </h2>
      </header>

      <article class="ui inverted segment back-about">
        <div class="ui stackable three column grid">
          <div class="column">
              
              <h3 id="我的生活">我的生活</h3>

<p>zouying</p>

<p>coder@baidu</p>

<h3 id="生活">生活</h3>

<p>两只猫，一只英短：钱多多，一只加菲猫：泡芙</p>

              
          </div>
          <div class="column">
              
          </div>
          <div class="column">
              
          </div>
        </div>
      </article>

      
      <footer class="ui secondary segment">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you likes to quote or reproduce.
      </footer>
      

      
      
    </section>

  </div>
</div>

      </section>
    </div>
  </div>

  
<script src="https://xpzouying.github.io/js/jquery.min.js"></script>
<script src="https://xpzouying.github.io/js/semantic.min.js"></script>
<script src="https://xpzouying.github.io/js/html2canvas.min.js"></script>
<script src="https://xpzouying.github.io/js/bg.js"></script>
<script src="https://xpzouying.github.io/js/site.js"></script>



</body>

</html>
